<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConnectedGoodsService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Uverify Backend</a> &gt; <a href="index.source.html" class="el_package">io.uverify.backend.extension.service</a> &gt; <span class="el_source">ConnectedGoodsService.java</span></div><h1>ConnectedGoodsService.java</h1><pre class="source lang-java linenums">/*
 * UVerify Backend
 * Copyright (C) 2025 Fabian Bormann
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU Affero General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU Affero General Public License for more details.
 *
 *  You should have received a copy of the GNU Affero General Public License
 *  along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package io.uverify.backend.extension.service;

import com.bloxbean.cardano.client.address.Address;
import com.bloxbean.cardano.client.address.AddressProvider;
import com.bloxbean.cardano.client.api.exception.ApiException;
import com.bloxbean.cardano.client.api.model.Amount;
import com.bloxbean.cardano.client.api.model.Result;
import com.bloxbean.cardano.client.api.model.Utxo;
import com.bloxbean.cardano.client.backend.api.BackendService;
import com.bloxbean.cardano.client.backend.api.DefaultUtxoSupplier;
import com.bloxbean.cardano.client.backend.api.UtxoService;
import com.bloxbean.cardano.client.backend.blockfrost.service.BFBackendService;
import com.bloxbean.cardano.client.backend.koios.Constants;
import com.bloxbean.cardano.client.backend.koios.KoiosBackendService;
import com.bloxbean.cardano.client.common.model.Network;
import com.bloxbean.cardano.client.exception.CborSerializationException;
import com.bloxbean.cardano.client.plutus.spec.ConstrPlutusData;
import com.bloxbean.cardano.client.plutus.spec.PlutusData;
import com.bloxbean.cardano.client.quicktx.QuickTxBuilder;
import com.bloxbean.cardano.client.quicktx.ScriptTx;
import com.bloxbean.cardano.client.quicktx.Tx;
import com.bloxbean.cardano.client.transaction.spec.Asset;
import com.bloxbean.cardano.client.transaction.spec.Transaction;
import com.bloxbean.cardano.client.util.HexUtil;
import com.bloxbean.cardano.yaci.store.common.domain.AddressUtxo;
import io.uverify.backend.enums.CardanoNetwork;
import io.uverify.backend.extension.ExtensionManager;
import io.uverify.backend.extension.UVerifyServiceExtension;
import io.uverify.backend.extension.dto.Item;
import io.uverify.backend.extension.dto.MintConnectedGoodsResponse;
import io.uverify.backend.extension.dto.SocialHub;
import io.uverify.backend.extension.entity.ConnectedGoodEntity;
import io.uverify.backend.extension.entity.ConnectedGoodUpdateEntity;
import io.uverify.backend.extension.entity.SocialHubEntity;
import io.uverify.backend.extension.repository.ConnectedGoodUpdateRepository;
import io.uverify.backend.extension.repository.ConnectedGoodsRepository;
import io.uverify.backend.extension.repository.SocialHubRepository;
import io.uverify.backend.extension.validators.ConnectedGoodsDatum;
import io.uverify.backend.extension.validators.ConnectedGoodsDatumItem;
import io.uverify.backend.extension.validators.SocialHubDatum;
import io.uverify.backend.extension.validators.SocialHubRedeemer;
import io.uverify.backend.extension.validators.converter.ConnectedGoodsDatumConverter;
import io.uverify.backend.extension.validators.converter.ConnectedGoodsDatumItemConverter;
import io.uverify.backend.extension.validators.converter.SocialHubDatumConverter;
import io.uverify.backend.extension.validators.converter.SocialHubRedeemerConverter;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;

import javax.crypto.Cipher;
import javax.crypto.SecretKey;
import javax.crypto.SecretKeyFactory;
import javax.crypto.spec.IvParameterSpec;
import javax.crypto.spec.PBEKeySpec;
import javax.crypto.spec.SecretKeySpec;
import java.math.BigInteger;
import java.nio.charset.StandardCharsets;
import java.security.SecureRandom;
import java.security.spec.KeySpec;
import java.util.*;

import static io.uverify.backend.extension.utils.ConnectedGoodUtils.*;
import static io.uverify.backend.util.CardanoUtils.fromCardanoNetwork;

@Service
<span class="fc" id="L87">@Slf4j</span>
@ConditionalOnProperty(value = &quot;extensions.connected-goods.enabled&quot;, havingValue = &quot;true&quot;)
public class ConnectedGoodsService implements UVerifyServiceExtension {

    private static final int CTR_IV_LENGTH = 16;
    private static final int KEY_LENGTH = 256;
    private static final int ITERATION_COUNT = 65536;
    @Autowired
    private final ConnectedGoodsRepository connectedGoodsRepository;
    @Autowired
    private final ConnectedGoodUpdateRepository connectedGoodUpdateRepository;
    @Autowired
    private final SocialHubRepository socialHubRepository;
    private final Network network;
    private final String salt;
    private BackendService backendService;

    @Autowired
    public ConnectedGoodsService(
            @Value(&quot;${cardano.backend.service.type}&quot;) String cardanoBackendServiceType,
            @Value(&quot;${cardano.backend.blockfrost.baseUrl}&quot;) String blockfrostBaseUrl,
            @Value(&quot;${cardano.backend.blockfrost.projectId}&quot;) String blockfrostProjectId,
            @Value(&quot;${extensions.connected-goods.encryption.salt}&quot;) String salt,
            @Value(&quot;${cardano.network}&quot;) String network,
            ConnectedGoodsRepository connectedGoodsRepository, SocialHubRepository socialHubRepository,
<span class="fc" id="L112">            @Autowired ExtensionManager extensionManager, ConnectedGoodUpdateRepository connectedGoodUpdateRepository) {</span>
<span class="fc" id="L113">        this.connectedGoodsRepository = connectedGoodsRepository;</span>
<span class="fc" id="L114">        this.connectedGoodUpdateRepository = connectedGoodUpdateRepository;</span>
<span class="fc" id="L115">        this.socialHubRepository = socialHubRepository;</span>
<span class="fc" id="L116">        this.salt = salt;</span>
<span class="fc" id="L117">        this.network = fromCardanoNetwork(CardanoNetwork.valueOf(network));</span>
<span class="fc" id="L118">        extensionManager.registerExtension(this);</span>

<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        if (cardanoBackendServiceType.equals(&quot;blockfrost&quot;)) {</span>
<span class="nc bnc" id="L121" title="All 4 branches missed.">            if (blockfrostProjectId == null || blockfrostProjectId.isEmpty()) {</span>
<span class="nc" id="L122">                throw new IllegalArgumentException(&quot;Blockfrost projectId is required when using Blockfrost backend service&quot;);</span>
            }

<span class="nc" id="L125">            this.backendService = new BFBackendService(</span>
                    blockfrostBaseUrl,
                    blockfrostProjectId);
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        } else if (cardanoBackendServiceType.equals(&quot;koios&quot;)) {</span>
<span class="nc" id="L129">            this.backendService = new KoiosBackendService(Constants.KOIOS_PREPROD_URL);</span>
        }
<span class="fc" id="L131">    }</span>

    public void setBackendService(BackendService backendService) {
<span class="fc" id="L134">        this.backendService = backendService;</span>
<span class="fc" id="L135">    }</span>

    public SocialHubEntity getSocialHubByBatchIdAndMintHash(String batchId, String mintHash) {
<span class="fc" id="L138">        Optional&lt;SocialHubEntity&gt; socialHubEntity = socialHubRepository.findByBatchIdAndMintHash(batchId, mintHash);</span>
<span class="fc" id="L139">        return socialHubEntity.orElse(null);</span>
    }

    public SocialHubEntity getSocialHubByBatchIdsAndItemId(String batchIds, String itemId) {
<span class="fc" id="L143">        Optional&lt;SocialHubEntity&gt; socialHubEntity = socialHubRepository.findByBatchIdsAndMintHash(Arrays.stream(batchIds.split(&quot;,&quot;)).toList(), applySHA3_256(itemId));</span>
<span class="fc" id="L144">        return socialHubEntity.orElse(null);</span>
    }

    public void processAddressUtxos(List&lt;AddressUtxo&gt; addressUtxos) {
<span class="fc bfc" id="L148" title="All 2 branches covered.">        for (AddressUtxo addressUtxo : addressUtxos) {</span>
            try {
<span class="fc bfc" id="L150" title="All 2 branches covered.">                if (includesConnectedGoodsToken(addressUtxo)) {</span>
<span class="fc" id="L151">                    ConnectedGoodsDatum connectedGoodsDatum = new ConnectedGoodsDatumConverter().deserialize(addressUtxo.getInlineDatum());</span>
<span class="fc" id="L152">                    String transactionId = addressUtxo.getTxHash();</span>
<span class="fc" id="L153">                    long slot = addressUtxo.getSlot();</span>

<span class="fc" id="L155">                    String batchId = HexUtil.encodeHexString(connectedGoodsDatum.getId());</span>
<span class="fc" id="L156">                    Optional&lt;ConnectedGoodEntity&gt; entry = connectedGoodsRepository.findById(batchId);</span>

                    ConnectedGoodEntity connectedGoodEntity;
<span class="fc" id="L159">                    ConnectedGoodUpdateEntity connectedGoodUpdateEntity = new ConnectedGoodUpdateEntity();</span>
<span class="fc" id="L160">                    connectedGoodUpdateEntity.setSlot(slot);</span>
<span class="fc" id="L161">                    connectedGoodUpdateEntity.setTransactionId(transactionId);</span>
<span class="fc" id="L162">                    connectedGoodUpdateEntity.setOutputIndex(addressUtxo.getOutputIndex());</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">                    if (entry.isEmpty()) {</span>
<span class="fc" id="L164">                        connectedGoodEntity = new ConnectedGoodEntity();</span>
<span class="fc" id="L165">                        connectedGoodEntity.setId(batchId);</span>
<span class="fc" id="L166">                        connectedGoodEntity.setCreationSlot(slot);</span>

<span class="fc" id="L168">                        List&lt;SocialHubEntity&gt; socialHubEntities = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">                        for (ConnectedGoodsDatumItem item : connectedGoodsDatum.getItems()) {</span>
<span class="fc" id="L170">                            SocialHubEntity socialHubEntity = new SocialHubEntity();</span>
<span class="fc" id="L171">                            socialHubEntity.setPassword(HexUtil.encodeHexString(item.getPassword()));</span>
<span class="fc" id="L172">                            socialHubEntity.setAssetId(item.getTokenName());</span>
<span class="fc" id="L173">                            socialHubEntity.setTransactionId(transactionId);</span>
<span class="fc" id="L174">                            socialHubEntity.setOutputIndex(addressUtxo.getOutputIndex());</span>
<span class="fc" id="L175">                            socialHubEntity.setCreationSlot(slot);</span>
<span class="fc" id="L176">                            socialHubEntities.add(socialHubEntity);</span>
<span class="fc" id="L177">                        }</span>

<span class="fc" id="L179">                        connectedGoodEntity.setUpdates(List.of(connectedGoodUpdateEntity));</span>
<span class="fc" id="L180">                        connectedGoodEntity.setSocialHubEntities(socialHubEntities);</span>
<span class="fc" id="L181">                    } else {</span>
<span class="fc" id="L182">                        connectedGoodEntity = entry.get();</span>
<span class="fc" id="L183">                        connectedGoodEntity.getUpdates().add(connectedGoodUpdateEntity);</span>

                    }
<span class="fc" id="L186">                    connectedGoodsRepository.save(connectedGoodEntity);</span>
                }

<span class="fc bfc" id="L189" title="All 2 branches covered.">                if (includesSocialHubToken(addressUtxo)) {</span>
<span class="fc" id="L190">                    SocialHubDatum socialHubDatum = new SocialHubDatumConverter().deserialize(addressUtxo.getInlineDatum());</span>
<span class="fc" id="L191">                    String transactionId = addressUtxo.getTxHash();</span>

<span class="fc" id="L193">                    String batchId = HexUtil.encodeHexString(socialHubDatum.getBatchId());</span>
<span class="fc" id="L194">                    String tokenName = getSocialHubTokenName(addressUtxo);</span>

<span class="pc bpc" id="L196" title="1 of 2 branches missed.">                    if (tokenName != null) {</span>
<span class="fc" id="L197">                        Optional&lt;SocialHubEntity&gt; optionalSocialHub = socialHubRepository.findByBatchIdAndAssetId(batchId, tokenName);</span>

<span class="pc bpc" id="L199" title="1 of 2 branches missed.">                        if (optionalSocialHub.isPresent()) {</span>
<span class="fc" id="L200">                            SocialHubEntity socialHubEntity = SocialHubEntity.fromSocialHubDatum(socialHubDatum);</span>

<span class="fc" id="L202">                            socialHubEntity.setTransactionId(transactionId);</span>
<span class="fc" id="L203">                            socialHubEntity.setOutputIndex(addressUtxo.getOutputIndex());</span>
<span class="fc" id="L204">                            socialHubEntity.setCreationSlot(addressUtxo.getSlot());</span>

<span class="fc" id="L206">                            SocialHubEntity previousSocialHubEntity = optionalSocialHub.get();</span>
<span class="fc" id="L207">                            socialHubEntity.setPassword(previousSocialHubEntity.getPassword());</span>
<span class="fc" id="L208">                            socialHubEntity.setAssetId(previousSocialHubEntity.getAssetId());</span>
<span class="fc" id="L209">                            socialHubEntity.setConnectedGood(previousSocialHubEntity.getConnectedGood());</span>
<span class="fc" id="L210">                            socialHubRepository.save(socialHubEntity);</span>
<span class="fc" id="L211">                        } else {</span>
<span class="nc" id="L212">                            log.warn(&quot;SocialHub not found for batchId: {} and tokenName: {}&quot;, batchId, tokenName);</span>
                        }
                    }
                }
<span class="nc" id="L216">            } catch (Exception e) {</span>
<span class="nc" id="L217">                e.printStackTrace();</span>
<span class="fc" id="L218">            }</span>
<span class="fc" id="L219">        }</span>
<span class="fc" id="L220">    }</span>

    public void handleRollbackToSlot(long slot) {
<span class="nc" id="L223">        connectedGoodsRepository.deleteAllAfterSlot(slot);</span>
<span class="nc" id="L224">        connectedGoodUpdateRepository.deleteAllAfterSlot(slot);</span>
<span class="nc" id="L225">        socialHubRepository.deleteAllAfterSlot(slot);</span>
<span class="nc" id="L226">    }</span>

    private SecretKey generateKey(String key) throws Exception {
<span class="fc" id="L229">        byte[] saltBytes = Base64.getDecoder().decode(salt);</span>
<span class="fc" id="L230">        SecretKeyFactory factory = SecretKeyFactory.getInstance(&quot;PBKDF2WithHmacSHA256&quot;);</span>
<span class="fc" id="L231">        KeySpec spec = new PBEKeySpec(key.toCharArray(), saltBytes, ITERATION_COUNT, KEY_LENGTH);</span>
<span class="fc" id="L232">        SecretKey tmp = factory.generateSecret(spec);</span>
<span class="fc" id="L233">        return new SecretKeySpec(tmp.getEncoded(), &quot;AES&quot;);</span>
    }

    private Optional&lt;byte[]&gt; encrypt(Optional&lt;byte[]&gt; plaintext, String key) throws Exception {
<span class="fc bfc" id="L237" title="All 2 branches covered.">        if (plaintext.isPresent()) {</span>
<span class="fc" id="L238">            return Optional.of(encrypt(plaintext.get(), key));</span>
        } else {
<span class="fc" id="L240">            return Optional.empty();</span>
        }
    }

    public byte[] encrypt(byte[] plaintext, String key) throws Exception {
<span class="fc" id="L245">        byte[] iv = new byte[CTR_IV_LENGTH];</span>
<span class="fc" id="L246">        SecureRandom random = SecureRandom.getInstanceStrong();</span>
<span class="fc" id="L247">        random.nextBytes(iv);</span>

<span class="fc" id="L249">        SecretKey secretKey = generateKey(key);</span>

<span class="fc" id="L251">        Cipher cipher = Cipher.getInstance(&quot;AES/CTR/NoPadding&quot;);</span>
<span class="fc" id="L252">        cipher.init(Cipher.ENCRYPT_MODE, secretKey, new IvParameterSpec(iv));</span>

<span class="fc" id="L254">        byte[] ciphertext = cipher.doFinal(plaintext);</span>

<span class="fc" id="L256">        byte[] encrypted = new byte[iv.length + ciphertext.length];</span>
<span class="fc" id="L257">        System.arraycopy(iv, 0, encrypted, 0, iv.length);</span>
<span class="fc" id="L258">        System.arraycopy(ciphertext, 0, encrypted, iv.length, ciphertext.length);</span>

<span class="fc" id="L260">        return encrypted;</span>
    }

    private String decrypt(byte[] encryptedText, String key) throws Exception {
<span class="pc bpc" id="L264" title="1 of 4 branches missed.">        if (encryptedText != null &amp;&amp; encryptedText.length &gt; CTR_IV_LENGTH) {</span>
<span class="fc" id="L265">            return decryptString(encryptedText, key);</span>
        } else {
<span class="fc" id="L267">            return null;</span>
        }
    }

    private String decryptString(byte[] encryptedText, String key) throws Exception {
<span class="fc" id="L272">        byte[] iv = Arrays.copyOfRange(encryptedText, 0, CTR_IV_LENGTH);</span>
<span class="fc" id="L273">        byte[] ciphertext = Arrays.copyOfRange(encryptedText, CTR_IV_LENGTH, encryptedText.length);</span>

<span class="fc" id="L275">        SecretKey secretKey = generateKey(key);</span>

<span class="fc" id="L277">        Cipher cipher = Cipher.getInstance(&quot;AES/CTR/NoPadding&quot;);</span>
<span class="fc" id="L278">        cipher.init(Cipher.DECRYPT_MODE, secretKey, new IvParameterSpec(iv));</span>

<span class="fc" id="L280">        byte[] decrypted = cipher.doFinal(ciphertext);</span>
<span class="fc" id="L281">        return new String(decrypted, StandardCharsets.UTF_8);</span>
    }

    private SocialHubDatum encryptSocialHub(SocialHubDatum plainSocialHub, String password) throws Exception {
<span class="fc" id="L285">        SocialHubDatum encryptedSocialHub = new SocialHubDatum();</span>
<span class="fc" id="L286">        encryptedSocialHub.setOwner(plainSocialHub.getOwner());</span>
<span class="fc" id="L287">        encryptedSocialHub.setBatchId(plainSocialHub.getBatchId());</span>
<span class="fc" id="L288">        encryptedSocialHub.setName(encrypt(plainSocialHub.getName(), password));</span>
<span class="fc" id="L289">        encryptedSocialHub.setSubtitle(encrypt(plainSocialHub.getSubtitle(), password));</span>
<span class="fc" id="L290">        encryptedSocialHub.setX(encrypt(plainSocialHub.getX(), password));</span>
<span class="fc" id="L291">        encryptedSocialHub.setTelegram(encrypt(plainSocialHub.getTelegram(), password));</span>
<span class="fc" id="L292">        encryptedSocialHub.setDiscord(encrypt(plainSocialHub.getDiscord(), password));</span>
<span class="fc" id="L293">        encryptedSocialHub.setYoutube(encrypt(plainSocialHub.getYoutube(), password));</span>
<span class="fc" id="L294">        encryptedSocialHub.setWebsite(encrypt(plainSocialHub.getWebsite(), password));</span>
<span class="fc" id="L295">        encryptedSocialHub.setEmail(encrypt(plainSocialHub.getEmail(), password));</span>
<span class="fc" id="L296">        encryptedSocialHub.setAdahandle(encrypt(plainSocialHub.getAdahandle(), password));</span>
<span class="fc" id="L297">        encryptedSocialHub.setReddit(encrypt(plainSocialHub.getReddit(), password));</span>
<span class="fc" id="L298">        encryptedSocialHub.setInstagram(encrypt(plainSocialHub.getInstagram(), password));</span>
<span class="fc" id="L299">        encryptedSocialHub.setGithub(encrypt(plainSocialHub.getGithub(), password));</span>
<span class="fc" id="L300">        encryptedSocialHub.setLinkedin(encrypt(plainSocialHub.getLinkedin(), password));</span>
<span class="fc" id="L301">        encryptedSocialHub.setPicture(encrypt(plainSocialHub.getPicture(), password));</span>
<span class="fc" id="L302">        return encryptedSocialHub;</span>
    }

    public SocialHub decryptSocialHub(SocialHub encryptedSocialHub, String password) throws Exception {
<span class="fc" id="L306">        SocialHub decryptedSocialHub = new SocialHub();</span>
<span class="fc" id="L307">        decryptedSocialHub.setOwner(encryptedSocialHub.getOwner());</span>
<span class="fc" id="L308">        decryptedSocialHub.setItemName(encryptedSocialHub.getItemName());</span>
<span class="fc" id="L309">        decryptedSocialHub.setName(decrypt(encryptedSocialHub.asBinaryName(), password));</span>
<span class="fc" id="L310">        decryptedSocialHub.setSubtitle(decrypt(encryptedSocialHub.asBinarySubtitle(), password));</span>
<span class="fc" id="L311">        decryptedSocialHub.setX(decrypt(encryptedSocialHub.asBinaryX(), password));</span>
<span class="fc" id="L312">        decryptedSocialHub.setTelegram(decrypt(encryptedSocialHub.asBinaryTelegram(), password));</span>
<span class="fc" id="L313">        decryptedSocialHub.setDiscord(decrypt(encryptedSocialHub.asBinaryDiscord(), password));</span>
<span class="fc" id="L314">        decryptedSocialHub.setYoutube(decrypt(encryptedSocialHub.asBinaryYoutube(), password));</span>
<span class="fc" id="L315">        decryptedSocialHub.setWebsite(decrypt(encryptedSocialHub.asBinaryWebsite(), password));</span>
<span class="fc" id="L316">        decryptedSocialHub.setEmail(decrypt(encryptedSocialHub.asBinaryEmail(), password));</span>
<span class="fc" id="L317">        decryptedSocialHub.setAdaHandle(decrypt(encryptedSocialHub.asBinaryAdahandle(), password));</span>
<span class="fc" id="L318">        decryptedSocialHub.setReddit(decrypt(encryptedSocialHub.asBinaryReddit(), password));</span>
<span class="fc" id="L319">        decryptedSocialHub.setInstagram(decrypt(encryptedSocialHub.asBinaryInstagram(), password));</span>
<span class="fc" id="L320">        decryptedSocialHub.setGithub(decrypt(encryptedSocialHub.asBinaryGithub(), password));</span>
<span class="fc" id="L321">        decryptedSocialHub.setLinkedin(decrypt(encryptedSocialHub.asBinaryLinkedin(), password));</span>
<span class="fc" id="L322">        decryptedSocialHub.setPicture(decrypt(encryptedSocialHub.asBinaryPicture(), password));</span>
<span class="fc" id="L323">        return decryptedSocialHub;</span>
    }

    public Transaction claim(String assetName, String password, String transactionId, int outputIndex, SocialHubDatum socialHubDatum, String userAddress) throws ApiException {
<span class="fc" id="L327">        Result&lt;Utxo&gt; output = backendService.getUtxoService().getTxOutput(transactionId, outputIndex);</span>
<span class="fc" id="L328">        Utxo utxo = output.getValue();</span>

<span class="fc" id="L330">        ConnectedGoodsDatum inputDatum = new ConnectedGoodsDatumConverter().deserialize(utxo.getInlineDatum());</span>
<span class="fc bfc" id="L331" title="All 2 branches covered.">        inputDatum.setItems(inputDatum.getItems().stream().filter(item -&gt; !item.getTokenName().equals(assetName)).toList());</span>
<span class="fc" id="L332">        ConstrPlutusData datum = new ConnectedGoodsDatumConverter().toPlutusData(inputDatum);</span>

<span class="fc" id="L334">        String scriptAddress = AddressProvider.getEntAddress(connectedGoodsScript, network).toBech32();</span>
<span class="fc" id="L335">        ConnectedGoodsDatumItem connectedGood = new ConnectedGoodsDatumItem(assetName, password.getBytes());</span>
<span class="fc" id="L336">        ConstrPlutusData redeemer = new ConnectedGoodsDatumItemConverter().toPlutusData(connectedGood);</span>

<span class="fc" id="L338">        Address address = new Address(userAddress);</span>
<span class="fc" id="L339">        byte[] ownerCredential = address.getPaymentCredentialHash().orElseThrow();</span>

<span class="fc" id="L341">        socialHubDatum.setOwner(ownerCredential);</span>
<span class="fc" id="L342">        socialHubDatum.setBatchId(inputDatum.getId());</span>

<span class="fc" id="L344">        String socialHubScriptAddress = AddressProvider.getEntAddress(socialHubScript, network).toBech32();</span>
<span class="fc" id="L345">        Asset asset = Asset.builder()</span>
<span class="fc" id="L346">                .name(connectedGood.getTokenName())</span>
<span class="fc" id="L347">                .value(BigInteger.ONE)</span>
<span class="fc" id="L348">                .build();</span>

        SocialHubDatum encryptedSocialHub;
        try {
<span class="fc" id="L352">            encryptedSocialHub = encryptSocialHub(socialHubDatum, password);</span>
<span class="nc" id="L353">        } catch (Exception exception) {</span>
<span class="nc" id="L354">            log.error(exception.getMessage(), exception);</span>
<span class="nc" id="L355">            throw new ApiException(&quot;Failed to encrypt social hub data&quot;, exception);</span>
<span class="fc" id="L356">        }</span>

<span class="fc" id="L358">        ScriptTx transaction = new ScriptTx()</span>
<span class="fc" id="L359">                .mintAsset(socialHubScript, List.of(asset),</span>
<span class="fc" id="L360">                        PlutusData.unit(),</span>
<span class="fc" id="L361">                        socialHubScriptAddress, new SocialHubDatumConverter().toPlutusData(encryptedSocialHub))</span>
<span class="fc" id="L362">                .attachSpendingValidator(connectedGoodsScript)</span>
<span class="fc" id="L363">                .collectFrom(utxo, redeemer)</span>
<span class="fc" id="L364">                .payToContract(scriptAddress, utxo.getAmount(), datum);</span>

<span class="fc" id="L366">        QuickTxBuilder quickTxBuilder = new QuickTxBuilder(backendService);</span>
<span class="fc" id="L367">        return quickTxBuilder.compose(transaction)</span>
<span class="fc" id="L368">                .collateralPayer(userAddress)</span>
<span class="fc" id="L369">                .feePayer(userAddress)</span>
<span class="fc" id="L370">                .withRequiredSigners(address)</span>
<span class="fc" id="L371">                .build();</span>
    }

    public MintConnectedGoodsResponse mint(String tokenName, List&lt;Item&gt; items, String userAddress) throws CborSerializationException {
<span class="fc" id="L375">        Map&lt;String, String&gt; itemMap = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L376" title="All 2 branches covered.">        for (Item item : items) {</span>
<span class="fc" id="L377">            itemMap.put(item.getAssetName(), item.getPassword());</span>
<span class="fc" id="L378">        }</span>
<span class="fc" id="L379">        return mint(tokenName, itemMap, userAddress);</span>
    }

    public MintConnectedGoodsResponse mint(String tokenName, Map&lt;String, String&gt; items, String userAddress) throws CborSerializationException {
<span class="fc" id="L383">        List&lt;ConnectedGoodsDatumItem&gt; connectedGoods = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L384">        items.forEach((assetName, password) -&gt; connectedGoods.add(new ConnectedGoodsDatumItem(assetName, HexUtil.decodeHexString(applySHA3_256(password)))));</span>

<span class="fc" id="L386">        UtxoService utxoService = backendService.getUtxoService();</span>
<span class="fc" id="L387">        DefaultUtxoSupplier utxoSupplier = new DefaultUtxoSupplier(utxoService);</span>

<span class="fc" id="L389">        List&lt;Utxo&gt; utxos = utxoSupplier.getAll(userAddress);</span>
<span class="pc bpc" id="L390" title="1 of 2 branches missed.">        if (utxos.isEmpty()) {</span>
<span class="nc" id="L391">            throw new IllegalStateException(&quot;No UTxOs found for facilitator account&quot;);</span>
        }

        // TODO: find UTXO with at least 2 ADA but also the smallest UTXO
<span class="fc" id="L395">        Optional&lt;Utxo&gt; optionalUtxo = utxos.stream().filter(utxo -&gt; {</span>
<span class="fc" id="L396">            Amount lovelace = utxo.getAmount().stream()</span>
<span class="fc" id="L397">                    .filter(amount -&gt; amount.getUnit().equals(&quot;lovelace&quot;)).findFirst().orElse(null);</span>

<span class="pc bpc" id="L399" title="1 of 2 branches missed.">            if (lovelace == null) {</span>
<span class="nc" id="L400">                return false;</span>
            }

<span class="pc bpc" id="L403" title="1 of 2 branches missed.">            return lovelace.getQuantity().compareTo(BigInteger.valueOf(3_000_000)) &gt; 0;</span>
<span class="fc" id="L404">        }).findFirst();</span>

<span class="pc bpc" id="L406" title="1 of 2 branches missed.">        if (optionalUtxo.isEmpty()) {</span>
<span class="nc" id="L407">            throw new IllegalStateException(&quot;No UTxOs found with at least 3 ADA&quot;);</span>
        }

<span class="fc" id="L410">        Utxo utxo = optionalUtxo.get();</span>
<span class="fc" id="L411">        String batchId = applySHA3_256(HexUtil.decodeHexString(utxo.getTxHash() + HexUtil.encodeHexString(String.valueOf(utxo.getOutputIndex()).getBytes())));</span>
<span class="fc" id="L412">        ConnectedGoodsDatum connectedGoodsDatum = new ConnectedGoodsDatum(</span>
<span class="fc" id="L413">                HexUtil.decodeHexString(batchId), connectedGoods);</span>
<span class="fc" id="L414">        ConstrPlutusData datum = new ConnectedGoodsDatumConverter().toPlutusData(connectedGoodsDatum);</span>

<span class="fc" id="L416">        String scriptAddress = AddressProvider.getEntAddress(connectedGoodsScript, network).toBech32();</span>
<span class="fc" id="L417">        Asset asset = Asset.builder()</span>
<span class="fc" id="L418">                .name(tokenName)</span>
<span class="fc" id="L419">                .value(BigInteger.ONE)</span>
<span class="fc" id="L420">                .build();</span>

<span class="fc" id="L422">        ScriptTx mintTransaction = new ScriptTx()</span>
<span class="fc" id="L423">                .mintAsset(connectedGoodsScript, asset, PlutusData.unit());</span>

<span class="fc" id="L425">        Tx sendTransaction = new Tx()</span>
<span class="fc" id="L426">                .from(userAddress)</span>
<span class="fc" id="L427">                .collectFrom(List.of(utxo))</span>
<span class="fc" id="L428">                .payToContract(scriptAddress, List.of(Amount.ada(1.0), Amount.asset(</span>
<span class="fc" id="L429">                                connectedGoodsScript.getPolicyId(), asset.getName(), BigInteger.ONE)),</span>
                        datum);

<span class="fc" id="L432">        QuickTxBuilder quickTxBuilder = new QuickTxBuilder(backendService);</span>
<span class="fc" id="L433">        Transaction unsignedTransaction = quickTxBuilder.compose(mintTransaction, sendTransaction)</span>
<span class="fc" id="L434">                .collateralPayer(userAddress)</span>
<span class="fc" id="L435">                .feePayer(userAddress)</span>
<span class="fc" id="L436">                .withRequiredSigners(new Address(userAddress))</span>
<span class="fc" id="L437">                .build();</span>

<span class="fc" id="L439">        String unsignedTransactionHex = unsignedTransaction.serializeToHex();</span>
<span class="fc" id="L440">        MintConnectedGoodsResponse response = new MintConnectedGoodsResponse();</span>
<span class="fc" id="L441">        response.setUnsignedTransaction(unsignedTransactionHex);</span>
<span class="fc" id="L442">        response.setBatchId(batchId);</span>
<span class="fc" id="L443">        response.setStatus(HttpStatus.OK);</span>
<span class="fc" id="L444">        return response;</span>
    }

    private Transaction modify(SocialHubDatum socialHubDatum, String transactionId, int outputIndex,
                               String userAddress, SocialHubRedeemer socialHubRedeemer, String password) throws ApiException {
<span class="fc" id="L449">        Result&lt;Utxo&gt; output = backendService.getUtxoService().getTxOutput(transactionId, outputIndex);</span>
<span class="fc" id="L450">        Utxo utxo = output.getValue();</span>

        SocialHubDatum encryptedSocialHubDatum;
        try {
<span class="fc" id="L454">            encryptedSocialHubDatum = encryptSocialHub(socialHubDatum, password);</span>
<span class="nc" id="L455">        } catch (Exception exception) {</span>
<span class="nc" id="L456">            log.error(exception.getMessage(), exception);</span>
<span class="nc" id="L457">            throw new ApiException(&quot;Failed to encrypt social hub data&quot;, exception);</span>
<span class="fc" id="L458">        }</span>

<span class="fc" id="L460">        ConstrPlutusData datum = new SocialHubDatumConverter().toPlutusData(encryptedSocialHubDatum);</span>
<span class="fc" id="L461">        ConstrPlutusData redeemer = new SocialHubRedeemerConverter().toPlutusData(socialHubRedeemer);</span>

<span class="fc" id="L463">        String socialHubScriptAddress = AddressProvider.getEntAddress(socialHubScript, network).toBech32();</span>
<span class="fc" id="L464">        ScriptTx transaction = new ScriptTx()</span>
<span class="fc" id="L465">                .attachSpendingValidator(socialHubScript)</span>
<span class="fc" id="L466">                .collectFrom(utxo, redeemer)</span>
<span class="fc" id="L467">                .payToContract(socialHubScriptAddress, utxo.getAmount(), datum);</span>

<span class="fc" id="L469">        QuickTxBuilder quickTxBuilder = new QuickTxBuilder(backendService);</span>
<span class="fc" id="L470">        Address address = new Address(userAddress);</span>

<span class="fc" id="L472">        return quickTxBuilder.compose(transaction)</span>
<span class="fc" id="L473">                .collateralPayer(userAddress)</span>
<span class="fc" id="L474">                .feePayer(userAddress)</span>
<span class="fc" id="L475">                .withRequiredSigners(address)</span>
<span class="fc" id="L476">                .build();</span>
    }

    public Transaction update(SocialHubDatum socialHubDatum, String transactionId, int outputIndex, String userAddress, String password) throws ApiException {
<span class="fc" id="L480">        return modify(socialHubDatum, transactionId, outputIndex, userAddress, SocialHubRedeemer.UPDATE, password);</span>
    }

    public Transaction transfer(SocialHubDatum socialHubDatum, String transactionId, int outputIndex, String userAddress, String password) throws ApiException {
<span class="nc" id="L484">        return modify(socialHubDatum, transactionId, outputIndex, userAddress, SocialHubRedeemer.TRANSFER, password);</span>
    }

    public ConnectedGoodUpdateEntity getLatestUpdateByConnectedGoodId(String id) {
<span class="nc" id="L488">        return connectedGoodUpdateRepository.getLatestUpdateByConnectedGoodId(id);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>